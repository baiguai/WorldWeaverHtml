<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorldWeaver</title>

    <!--
        Formatting notes:
        This code is formatted for indentation level folding.
        There are sections indented between comments, so that they
        remain collapsed at certain levels, to make code navigation
        and reading easier.
    -->

    <!-- Styles -->
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }

            body {
                background-color: black;
                color: white;
                font-family: monospace;
                display: flex;
                flex-direction: column;
                height: 100dvh; /* better on mobile than 100vh */
                overflow: hidden;
            }

            #game-interface {
                display: flex;
                flex-direction: column;
                flex: 1;
                min-height: 0; /* Allows flex children to shrink properly */
            }

            #output {
                flex: 1;
                padding: 10px;
                overflow-y: auto;
                white-space: pre-wrap;
                border-bottom: 1px solid white;
                min-height: 0;
            }

            #input-container {
                display: flex;
                padding: 10px;
                background: black;
                border-top: 1px solid white;
            }

            #input {
                flex: 1;
                background: black;
                color: white;
                border: none;
                padding: 10px;
                font-size: 1rem;
                font-family: monospace;
            }

            #input:focus {
                outline: none;
            }

            .link {
                cursor: pointer;
                text-decoration: underline;
            }
        </style>
    <!-- End Styles -->
</head>
<body>
    <div id="game-interface" style="display: none;">
        <div id="output"></div>
        <div id="input-container">
            <input type="text" id="input" autofocus="">
        </div>
    </div>
    <div id="fight-interface" style="display: none; flex-direction: column; flex: 1; padding: 20px; position: relative;">
        <div style="position: absolute; top: 20px; left: 20px;">
            <div>Player Life: <span id="player-life">0</span></div>
            <div>Enemy Life: <span id="enemy-life">0</span></div>
        </div>

        <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
            <div style="margin-right: 50px;">
<?xml version="1.0" encoding="UTF-8" standalone="no"?> <svg width="24mm" height="48mm" viewBox="0 0 24 48" version="1.1" id="svg130" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs127" /><g id="layer1"><path style="fill:#ffffff;stroke-width:0.0108946;fill-opacity:1" d="M 9.9604001,38.69619 C 9.1735285,38.629484 8.4623604,38.17153 8.0843307,37.488105 7.9507341,37.24658 7.870335,37.011109 7.8200355,36.714041 7.8017565,36.606089 7.8004786,36.372934 7.7973387,32.574079 l -0.00333,-4.025568 -1.4102125,-1.127595 -1.4102126,-1.127595 0.00318,-1.710457 c 0.00338,-1.820078 0.00238,-1.781662 0.056602,-2.168033 0.1429605,-1.018659 0.5499296,-2.002058 1.1722421,-2.832605 0.8195195,-1.093743 1.9706849,-1.887415 3.2876982,-2.266707 0.092367,-0.0266 0.1692362,-0.04966 0.1708214,-0.05125 0.00158,-0.0016 -0.04911,-0.03224 -0.1126549,-0.06811 -0.9459878,-0.534086 -1.638575,-1.430681 -1.901845,-2.462049 -0.09383,-0.367586 -0.1212933,-0.594871 -0.1211102,-1.002307 1.525e-4,-0.336912 0.013863,-0.486067 0.071107,-0.773519 0.2291196,-1.150525 0.9535944,-2.135622 1.9905447,-2.70662 0.4477091,-0.246532 0.9425221,-0.4021994 1.4783391,-0.4650843 0.208138,-0.024428 0.663432,-0.024428 0.871571,0 0.660553,0.077524 1.244326,0.2908173 1.781273,0.6508233 1.348343,0.904022 2.004513,2.502753 1.683019,4.100603 -0.22342,1.110414 -0.941096,2.090095 -1.947257,2.658153 -0.06354,0.03588 -0.114249,0.06652 -0.112675,0.06809 0.0016,0.0016 0.0858,0.02703 0.187163,0.05657 0.851626,0.248175 1.600864,0.64847 2.292414,1.224765 0.197027,0.164191 0.577186,0.542335 0.740962,0.737037 0.779499,0.926689 1.263046,2.014057 1.415711,3.183554 0.04772,0.365587 0.0475,0.356369 0.05108,2.122134 l 0.0035,1.70501 -1.356182,1.083526 -1.356183,1.083526 -9e-6,4.004269 c -6e-6,2.579841 -0.0039,4.0469 -0.01089,4.12411 -0.09012,0.992235 -0.817878,1.817908 -1.809776,2.05328 -0.256853,0.06095 -0.191317,0.05882 -1.87805,0.06106 -0.856863,0.0011 -1.605543,-0.002 -1.6637348,-0.0069 z" id="path266" /></g></svg>
            </div>
            <div style="margin-left: 50px;">
<?xml version="1.0" encoding="UTF-8" standalone="no"?> <svg width="24mm" height="48mm" viewBox="0 0 24 48" version="1.1" id="svg130" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs127" /><g id="layer1"><path style="fill:#ffffff;stroke-width:0.0404355;fill-opacity:1" d="m 2.4287764,35.493786 0.00823,-0.960343 0.7986009,-0.01096 0.7986008,-0.01096 V 33.62279 32.734064 h 0.626095 0.6260953 l 0.01145,-8.380254 0.01145,-8.380255 0.090076,-0.26283 C 5.708615,14.808398 6.5057076,14.151126 7.3987593,14.062059 l 0.2948604,-0.02941 0.011162,-0.616641 0.011162,-0.616641 h 1.0704875 1.070487 v -0.62675 -0.62675 h 2.1430808 2.143081 v 0.62675 0.62675 h 1.070487 1.070487 l 0.01116,0.616641 0.01116,0.616641 0.280694,0.02774 c 0.908081,0.08973 1.700375,0.738819 2.014441,1.650337 l 0.09056,0.26283 0.01076,8.380255 0.01076,8.380254 h 0.626096 0.626095 v 0.888726 0.888726 l 0.7986,0.01096 0.798601,0.01096 0.0082,0.960343 0.0082,0.960343 H 20.004275 18.42917 v -0.970452 -0.970452 h -1.43546 -1.435459 v -1.152411 -1.152411 h -0.424209 -0.424209 l -0.01047,2.092536 -0.01047,2.092536 -1.08165,0.01077 -1.081649,0.01077 v -2.103306 -2.103305 h -0.525661 -0.525661 v 2.103305 2.103306 l -1.08165,-0.01077 -1.0816489,-0.01077 -0.010473,-2.092536 -0.010473,-2.092536 H 8.8658849 8.4416762 v 1.152411 1.152411 H 7.0062165 5.5707567 v 0.970452 0.970452 H 3.9956514 2.4205461 Z M 10.82737,25.341148 c 0.0158,-0.23176 0.03735,-0.309004 0.09871,-0.353811 0.115072,-0.08404 2.073205,-0.08404 2.188277,0 0.06136,0.04481 0.08291,0.122051 0.09871,0.353811 l 0.02022,0.296488 0.602558,0.01122 0.602557,0.01122 -0.02539,-0.357651 c -0.04176,-0.588281 -0.238172,-1.077936 -0.521921,-1.301133 -0.05945,-0.04676 -0.195383,-0.125322 -0.302077,-0.174578 -0.188224,-0.08689 -0.234869,-0.08955 -1.569677,-0.08955 h -1.375689 l -0.261948,0.12977 c -0.298081,0.147669 -0.4563327,0.323463 -0.5906901,0.656167 -0.1371612,0.339646 -0.2294693,1.028067 -0.1486829,1.108854 0.015411,0.01541 0.2838013,0.02299 0.596423,0.01685 l 0.568404,-0.01117 z M 9.7356117,20.461894 V 19.956451 H 8.9875552 8.2394988 v 0.505443 0.505444 h 0.7480564 0.7480565 z m 6.0653233,0 v -0.505443 h -0.748057 -0.748056 v 0.505443 0.505444 h 0.748056 0.748057 z" id="path6103" /></g></svg>
            </div>
        </div>

        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
            <button onclick="attackEnemy()">Attack</button>
            <button onclick="exitFight()">Flee</button>
        </div>
    </div>
    
    <script>
        let database = [
  {"ElementType":"game","ElementKey":"game","Name":"Sample Game","ParentKey":null,"Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"player","ElementKey":"player","Name":"","ParentKey":"home","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"pf4wcjaqs9jm8zq6awm","Name":"admin pass","ParentKey":"game","Syntax":"","Logic":"","Output":"admin","Tags":"!_adminpass","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"","ElementKey":"9wh0ai7glyhm8zq92fn","Name":"error","ParentKey":"game","Syntax":"","Logic":"","Output":"I don't understand what you are trying to do.","Tags":"!_error","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"message","ElementKey":"nyoy47hnhtgm8zqaoi8","Name":"die message","ParentKey":"game","Syntax":"","Logic":"","Output":"You have died.","Tags":"!_die","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},
  {"ElementType":"attribute","ElementKey":"j0j70z5382m91nuded","Name":"stats dice","ParentKey":"player","Syntax":"","Logic":"","Output":"[rand:3|5]","Tags":"stats_dice","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"dra3hmv3nnem91nvmgq","Name":"money dice","ParentKey":"player","Syntax":"","Logic":"","Output":"[rand:4|6]","Tags":"money_dice","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"z9tqbp2st2m91nw9ep","Name":"life roll","ParentKey":"player","Syntax":"","Logic":"","Output":"[rand:<<[self]((stats_dice))>>|6]","Tags":"life_roll","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"z2i2lbhfwxm91nwx9d","Name":"armor roll","ParentKey":"player","Syntax":"","Logic":"","Output":"[rand:<<[self]((stats_dice))>>|6]","Tags":"armor_roll","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"2au1o4qznt5m91nxeao","Name":"strength roll","ParentKey":"player","Syntax":"","Logic":"","Output":"[rand:<<[self]((stats_dice))>>|5]","Tags":"strength_roll","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},
  {"ElementType":"attribute","ElementKey":"az85m9vwmcbm91nxw20","Name":"intelligence roll","ParentKey":"player","Syntax":"","Logic":"","Output":"[rand:<<[self]((stats_dice))>>|5]","Tags":"intelligence_roll","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"6jdbqtsxpanm91nyncm","Name":"cunning roll","ParentKey":"player","Syntax":"","Logic":"","Output":"[rand:<<[self]((stats_dice))>>|5]","Tags":"cunning_roll","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"pvzdehgcs28m91nz4ta","Name":"gold roll","ParentKey":"player","Syntax":"","Logic":"","Output":"[rand:<<[self]((money_dice))>>|9]","Tags":"gold_roll","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"3e573l95rtkm91o5dpu","Name":"Life","ParentKey":"player","Syntax":"","Logic":"","Output":"[roll:(8)<<[self]((life_roll))>>d6]","Tags":"stats|life","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"uonxrshx72rm91o71d3","Name":"max life","ParentKey":"player","Syntax":"","Logic":"","Output":"player((life))","Tags":"maxlife","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},
  {"ElementType":"attribute","ElementKey":"kd8qk3jx4vhm91o7sji","Name":"Armor","ParentKey":"player","Syntax":"","Logic":"","Output":"[roll:(6)<<[self]((armor_roll))>>d6+3]","Tags":"stats|armor","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"kcchdhvqojam91o8zat","Name":"Strength","ParentKey":"player","Syntax":"","Logic":"","Output":"[roll:(6)<<[self]((strength_roll))>>d6]","Tags":"stats","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"ccowsmp5kc6m91oa4us","Name":"Intelligence","ParentKey":"player","Syntax":"","Logic":"","Output":"[roll:(6)<<[self]((intelligence_roll))>>d6]","Tags":"stats","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"xvpexadit7hm91oas1w","Name":"Cunning","ParentKey":"player","Syntax":"","Logic":"","Output":"[roll:(6)<<[self]((cunning_roll))>>d6]","Tags":"stats","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"yv26edvaibom91ocqjl","Name":"Gold","ParentKey":"player","Syntax":"","Logic":"","Output":"[roll:<<[self]((gold_roll))>>d8]","Tags":"stats|gold","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},
  {"ElementType":"attribute","ElementKey":"player_armed","Name":"armed weapon","ParentKey":"player","Syntax":"","Logic":"","Output":"long-sword_01","Tags":"armed|stats|name","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"experience","Name":"Experience","ParentKey":"player","Syntax":"","Logic":"","Output":"0","Tags":"experience|stats","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"cur_heal_round","Name":"cur heal round","ParentKey":"player","Syntax":"","Logic":"","Output":"0","Tags":"","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"4yru4bgbvolm91onmxr","Name":"Quest","ParentKey":"player","Syntax":"","Logic":"","Output":"","Tags":"stats|quest","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attackplayer","ElementKey":"ym8tqvff76im91ooiy7","Name":"Attack Player","ParentKey":"player","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},
  {"ElementType":"attack","ElementKey":"tydkk947zvpm91op8ta","Name":"Attack","ParentKey":"ym8tqvff76im91ooiy7","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"82t6lun7um4m91opqwu","Name":"target","ParentKey":"tydkk947zvpm91op8ta","Syntax":"","Logic":"","Output":"[player]","Tags":"target","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"object","ElementKey":"long-sword_01","Name":"Long Sword","ParentKey":"player","Syntax":"/\\b(.*your .*sword|.*sword)\\b/","Logic":"","Output":"","Tags":"inventory","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"74yr0t7hrm91ouzn5","Name":"Damage","ParentKey":"long-sword_01","Syntax":"","Logic":"[rand:4|12]","Output":"","Tags":"damage","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"79liampktaem91ow6sv","Name":"friendly name","ParentKey":"long-sword_01","Syntax":"","Logic":"","Output":"a Long Sword","Tags":"title","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},
  {"ElementType":"global","ElementKey":"3ielqbe2ltm91oyuf9","Name":"Global","ParentKey":null,"Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"69lyn6u2u6nm91p0qv7","Name":"Title","ParentKey":"3ielqbe2ltm91oyuf9","Syntax":"\\b(title)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"","ElementKey":"vl9tfy7wmkm91p1baj","Name":"show game title","ParentKey":"69lyn6u2u6nm91p0qv7","Syntax":"","Logic":"game_title","Output":"","Tags":"key","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"du2fxwfitpum91p248p","Name":"Stats","ParentKey":"3ielqbe2ltm91oyuf9","Syntax":"\\b(stats)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"action","ElementKey":"6tqadr9itmpm91p2w5t","Name":"show stats","ParentKey":"du2fxwfitpum91p248p","Syntax":"","Logic":"[player]((stats))","Output":"Stats:","Tags":"list","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},
  {"ElementType":"input","ElementKey":"0e9uq8d1xdim91p5y52","Name":"Inventory","ParentKey":"3ielqbe2ltm91oyuf9","Syntax":"\\b(inventory|inv)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"","ElementKey":"pohxz1iocgm91p6pom","Name":"show inventory","ParentKey":"0e9uq8d1xdim91p5y52","Syntax":"","Logic":"[player]((inventory))","Output":"Inventory:","Tags":"list","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"w97g79kzvugm91p7k05","Name":"Arm","ParentKey":"3ielqbe2ltm91oyuf9","Syntax":"\\b(arm .*)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"set","ElementKey":"51w1x5oxgt3m91p86i4","Name":"set armed weapon","ParentKey":"w97g79kzvugm91p7k05","Syntax":"","Logic":"player_armed","Output":"","Tags":"arm","Repeat":"","RepeatIndex":"","Template":"","Active":"true","Sort":""},{"ElementType":"","ElementKey":"at73dh77pchm92hdikb","Name":"ROOMS","ParentKey":null,"Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},
  {"ElementType":"room","ElementKey":"home","Name":"Testing Home Room","ParentKey":"at73dh77pchm92hdikb","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"enter_message","ElementKey":"3yiz09d87evm92hgek0","Name":"Enter Message","ParentKey":"home","Syntax":"","Logic":"","Output":"Welcome to the WorldWeaver Testing Game.\nTo enter a test room simply enter its name.\n(No need to say \"go to\").\n","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"look","ElementKey":"n1oy3odne3dm92hiusl","Name":"Look","ParentKey":"home","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"message","ElementKey":"gos1iqg1rgqm92hjg25","Name":"Look Msg","ParentKey":"n1oy3odne3dm92hiusl","Syntax":"","Logic":"","Output":"You are in the testing room.\nTo enter a test room simply enter its name.\n(No need to say \"go to\").\n","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"navigation","ElementKey":"xhxecxcl42lm92iow8c","Name":"Navigation","ParentKey":"home","Syntax":"","Logic":"","Output":"","Tags":"look|enter_message","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},
  {"ElementType":"message","ElementKey":"tr9whrpn83m92ipps2","Name":"Nav Msg","ParentKey":"xhxecxcl42lm92iow8c","Syntax":"","Logic":"","Output":"\n\nGo to Time Room (first)\nGo to Gold Room.\nGo to Traveling.\nGo to Taking and Putting.\nGo to Fight.\nGo to Weapon Arming.\nGo to Npc Follow.\nGo to Npc Path.\nGo to Tests Room.\nGo to Output Logic Test 01.\nGo to Dev Note.\nGo to Conversation Room.\nGo to Die Room.\nGo to Spawn Room\nGo to Ammo Room","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"","ElementKey":"zfofgknktfkm92iqoxe","Name":"INJECTIONS","ParentKey":null,"Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"inj_look","Name":"Inj Look","ParentKey":"zfofgknktfkm92iqoxe","Syntax":"\\b(look|l)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"action","ElementKey":"xs69bo34pndm92isgbk","Name":"Inj Look Action","ParentKey":"inj_look","Syntax":"","Logic":"look","Output":"","Tags":"type|room","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"!_start","ElementKey":"suli02fs0cm92js21q","Name":"Start Screen","ParentKey":"game","Syntax":"","Logic":"","Output":"Welcome to\n\n\n▓█████▄  ▄▄▄       ██▀███   ██ ▄█▀         \n▒██▀ ██▌▒████▄    ▓██ ▒ ██▒ ██▄█▒          \n░██   █▌▒██  ▀█▄  ▓██ ░▄█ ▒▓███▄░          \n░▓█▄   ▌░██▄▄▄▄██ ▒██▀▀█▄  ▓██ █▄          \n░▒████▓  ▓█   ▓██▒░██▓ ▒██▒▒██▒ █▄         \n ▒▒▓  ▒  ▒▒   ▓▒█░░ ▒▓ ░▒▓░▒ ▒▒ ▓▒         \n ░ ▒  ▒   ▒   ▒▒ ░  ░▒ ░ ▒░░ ░▒ ▒░         \n ░ ░  ░   ░   ▒     ░░   ░ ░ ░░ ░          \n   ░          ░  ░   ░     ░  ░            \n ░                                         \n █     █░ ▒█████   ██▀███   ██▓    ▓█████▄ \n▓█░ █ ░█░▒██▒  ██▒▓██ ▒ ██▒▓██▒    ▒██▀ ██▌\n▒█░ █ ░█ ▒██░  ██▒▓██ ░▄█ ▒▒██░    ░██   █▌\n░█░ █ ░█ ▒██   ██░▒██▀▀█▄  ▒██░    ░▓█▄   ▌\n░░██▒██▓ ░ ████▓▒░░██▓ ▒██▒░██████▒░▒████▓ \n░ ▓░▒ ▒  ░ ▒░▒░▒░ ░ ▒▓ ░▒▓░░ ▒░▓  ░ ▒▒▓  ▒ \n  ▒ ░ ░    ░ ▒ ▒░   ░▒ ░ ▒░░ ░ ▒  ░ ░ ▒  ▒ \n  ░   ░  ░ ░ ░ ▒    ░░   ░   ░ ░    ░ ░  ░ \n    ░        ░ ░     ░         ░  ░   ░    \n                                    ░  \n\n","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},
  {"ElementType":"attribute","ElementKey":"n4n2fxgt2tm930w294","Name":"File Name","ParentKey":"game","Syntax":"","Logic":"","Output":"sample","Tags":"!_filename","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"room","ElementKey":"gold_room","Name":"Gold Room","ParentKey":"at73dh77pchm92hdikb","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"enter_message","ElementKey":"csgxp4xttqjm95dfyhv","Name":"enter message","ParentKey":"gold_room","Syntax":"","Logic":"","Output":"Welcome to the Gold Room.\n","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"33qw3awzi5am95dh8zu","Name":"GoldRoom Door","ParentKey":"home","Syntax":"\\b(gold room)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"move","ElementKey":"k3gzbw6wmpqm95difm9","Name":"GoldRoomDoor Action","ParentKey":"33qw3awzi5am95dh8zu","Syntax":"","Logic":"gold_room","Output":"You have decided to test receiving money.\n\n","Tags":"[player]","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},
  {"ElementType":"look","ElementKey":"byhgzjzj7qvm99nqh7r","Name":"Look","ParentKey":"gold_room","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"message","ElementKey":"9o7qgeoftqfm99nqsum","Name":"Look Message","ParentKey":"byhgzjzj7qvm99nqh7r","Syntax":"","Logic":"","Output":"You look around.\nYou are in a small room.\n","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"dws4anifpxm99nruo4","Name":"Look Input","ParentKey":"gold_room","Syntax":"\\b(look|l)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"action","ElementKey":"vzg2gexfy2qm99nsado","Name":"Look Action","ParentKey":"dws4anifpxm99nruo4","Syntax":"","Logic":"look","Output":"","Tags":"type|room","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"fyf8b0e469mm99op8iu","Name":"Home Input","ParentKey":"gold_room","Syntax":"\\b(home)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},
  {"ElementType":"move","ElementKey":"m8p6rq3wzjgm99oruk2","Name":"HomeDoor Action","ParentKey":"fyf8b0e469mm99op8iu","Syntax":"","Logic":"home","Output":"","Tags":"[player]","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"navigation","ElementKey":"obo9905ejlam99otgpl","Name":"Navigation","ParentKey":"gold_room","Syntax":"","Logic":"","Output":"","Tags":"look|enter_message","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"message","ElementKey":"uri9nmp4ufam99ots0h","Name":"Nav Msg","ParentKey":"obo9905ejlam99otgpl","Syntax":"","Logic":"","Output":"\n\nYou can return home using:\nhome","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"q359kjev8q9m9b4b60y","Name":"Look Input","ParentKey":"home","Syntax":"\\b(look|l)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"action","ElementKey":"m5ypte6dvlm9b4bm9u","Name":"Look Action","ParentKey":"q359kjev8q9m9b4b60y","Syntax":"","Logic":"look","Output":"","Tags":"type|room","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},
  {"ElementType":"object","ElementKey":"zcfyy2e69fm9b4ht2r","Name":"Gold Coin","ParentKey":"gold_room","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"4fecftfhp3vm9b4jon6","Name":"moved","ParentKey":"zcfyy2e69fm9b4ht2r","Syntax":"","Logic":"","Output":"false","Tags":"moved","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"look","ElementKey":"awmyn3yxzydm9b4l1i0","Name":"Look","ParentKey":"zcfyy2e69fm9b4ht2r","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"message","ElementKey":"j5qqe3os2om9b4lkog","Name":"Look Message","ParentKey":"awmyn3yxzydm9b4l1i0","Syntax":"","Logic":"","Output":"\nYou see a gold coin.","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"enter_message","ElementKey":"ntrf9qy5mgm9bt126v","Name":"enter message","ParentKey":"zcfyy2e69fm9b4ht2r","Syntax":"","Logic":"","Output":"You see a gold coin.\n","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},
  {"ElementType":"logic","ElementKey":"r694vnch6sm9cin5d3","Name":"Moved Logic","ParentKey":"awmyn3yxzydm9b4l1i0","Syntax":"","Logic":"?[self]((moved)) = 'false'","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"xft1rox6b1rm9gt5pnn","Name":"Take Coin","ParentKey":"zcfyy2e69fm9b4ht2r","Syntax":"\\b(take gold coin|take coin)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"move","ElementKey":"j2oimcm7sydm9gt90pb","Name":"Take Move","ParentKey":"xft1rox6b1rm9gt5pnn","Syntax":"","Logic":"limbo","Output":"You take the gold coin.\n","Tags":"[self]","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"set","ElementKey":"zg519drfg1km9gteyn6","Name":"Take Action","ParentKey":"xft1rox6b1rm9gt5pnn","Syntax":"","Logic":"[player]((gold))","Output":"+=1","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"room","ElementKey":"fight_room","Name":"Fight Room","ParentKey":"at73dh77pchm92hdikb","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},
  {"ElementType":"navigation","ElementKey":"0g0niphdneaem9o0s1lx","Name":"Navigation","ParentKey":"fight_room","Syntax":"","Logic":"","Output":"","Tags":"look|enter_message","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"message","ElementKey":"lzjuj21s7rcm9o0sjss","Name":"Nav Msg","ParentKey":"0g0niphdneaem9o0s1lx","Syntax":"","Logic":"","Output":"\n\nYou can return home using:\nhome","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"2pkk0i39nzam9o0tnuk","Name":"FightRoom Door","ParentKey":"home","Syntax":"\\b(fight)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"move","ElementKey":"udw9767eszrm9o0ujnu","Name":"FightRoomDoor Action","ParentKey":"2pkk0i39nzam9o0tnuk","Syntax":"","Logic":"fight_room","Output":"You have decided to test the fight room.","Tags":"[player]","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"kqq9ogdt4vm9o0w2q1","Name":"Home Input","ParentKey":"fight_room","Syntax":"\\b(home)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},
  {"ElementType":"move","ElementKey":"tsjdi0fijplm9o0wu7t","Name":"HomeDoor Action","ParentKey":"kqq9ogdt4vm9o0w2q1","Syntax":"","Logic":"home","Output":"","Tags":"[player]","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"zxuhe5uchxbm9o11rdv","Name":"Look Input","ParentKey":"fight_room","Syntax":"\\b(look|l)\\b","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"action","ElementKey":"47ru55jsbqym9o12wor","Name":"Look Action","ParentKey":"zxuhe5uchxbm9o11rdv","Syntax":"","Logic":"look","Output":"","Tags":"type|room","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"look","ElementKey":"6sfry8c4c0nm9o13ntn","Name":"Look","ParentKey":"fight_room","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"message","ElementKey":"qm98k4dvvym9o14gky","Name":"Look Message","ParentKey":"6sfry8c4c0nm9o13ntn","Syntax":"","Logic":"","Output":"You look around.\nYou are in the fight test room.\n","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},
  {"ElementType":"object","ElementKey":"v1uynzyvm4qm9o1c6xn","Name":"Spawn Button","ParentKey":"fight_room","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"enter_message","ElementKey":"slufsccds0rm9o1dvs9","Name":"enter message","ParentKey":"v1uynzyvm4qm9o1c6xn","Syntax":"","Logic":"","Output":"\nYou see a red button in the center of the room.\n","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"input","ElementKey":"804msoqw0vqm9o1f3r3","Name":"Click Input","ParentKey":"v1uynzyvm4qm9o1c6xn","Syntax":"\\b(click.*button|press.*button)\\b","Logic":"","Output":"\nYou've pressed the button.\n","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"look","ElementKey":"a4rhlx63sxhm9o28c8k","Name":"Look","ParentKey":"v1uynzyvm4qm9o1c6xn","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"message","ElementKey":"d0qgpuzynltm9o28q7g","Name":"Look Message","ParentKey":"a4rhlx63sxhm9o28c8k","Syntax":"","Logic":"","Output":"\nYou see a red button in the middle of the room.","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},
  {"ElementType":"npc","ElementKey":"6oq5c7d7hvm9pblioa","Name":"Npc Rat","ParentKey":"m80q9u9n9cjm9pblryi","Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"","ElementKey":"m80q9u9n9cjm9pblryi","Name":"Npcs","ParentKey":null,"Syntax":"","Logic":"","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"qrd50b66eqlm9pbpp9a","Name":"stats dice","ParentKey":"6oq5c7d7hvm9pblioa","Syntax":"","Logic":"[rand:3|4]","Output":"","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""},{"ElementType":"attribute","ElementKey":"bv08g96f5gsm9pbr9ec","Name":"life_roll","ParentKey":"6oq5c7d7hvm9pblioa","Syntax":"","Logic":"","Output":"[rand:<<[self]((stats_dice))>>|6]","Tags":"","Repeat":"","RepeatIndex":"0","Template":"","Active":"true","Sort":""}
];

        // Parsers
            const actionParsers = ["attribute", "logic", "input", "action", "set", "move", "message"];
            const attackParsers = ["attribute", "logic", "action"];
            const fleeParsers = ["attribute", "logic", "action"]; 
            const attributeParsers = ["attribute"];
            const enterMessageParsers = ["logic", "message", "action", "attack"];
            const gameParsers = ["set_field", "set_game_state", "message", "action", "room", "input"];
            const globalParsers = ["logic", "input", "action", "message"];
            const inputParsers = ["logic", "preset", "set", "action", "attack", "flee", "message", "move"];
            const logicParsers = ["logic", "action", "set", "message"];
            const messageParssers = ["logic", "action", "message", "set"];
            const navigationParsers = ["message"];
            const generalParsers = ["logic", "enter_message", "message", "action", "set"];
            const moveParsers = ["logic", "set", "message"];
            const npcParsers = ["link", "travel", "enter_message", "logic", "input", "action", "attack", "set", "message", "dev_note"];
            const objectParsers = ["link", "travel", "enter_message", "object", "logic", "action", "set", "move", "message", "input", "dev_note"];
            const playerParsers = ["link", "message", "attack", "flee", "input", "dev_note"];
            const roomParsers = ["link", "logic", "action", "enter_message", "set", "object", "message", "input", "npc", "navigation", "move", "dev_note"];
            const roundParsers = ["link", "logic", "action", "set"];
            const rulesetParsers = ["rule"];
            const ruleParsers = ["rule"];
            const setParsers = ["logic", "set"];
            const testParsers = ["teststep"];
            const travelParsers = ["enter_message", "logic", "move", "message"];
            const weaponParsers = ["dev_note"];

        // Config Items
            const fields = ["ElementType", "ElementKey", "Name", "ParentKey", "Syntax", "Logic", "Output", "Tags"];
            const selfTypes = ["object", "room", "player", "npc", "game", "global"];
            const canContainCustomElems = ["npc", "object", "room"];
            const operands = [" != ", " >= ", "<= ", " !~~ ", " ~~ ", " >< ", " <> ", " = ", " > ", " < "];

        // Classes
            let gameOutput = {
                "MatchMade": "false",
                "ContinueParsing": "true",
                "EnterMsgDone": "false",
                "LogicPassed": "true",
                "Output": ""
            };
            let userInput = {
                "Input": ""
            };

        // Global Vars
            let gameStarted = false;
            const output = document.getElementById("output");
            const input = document.getElementById("input");
            const gameInterface = document.getElementById("game-interface");
            const elementTypes = [
                "action", "attack", "attribute", "dev_note", "enter_message", "global", "injection",
                "input", "link", "logic", "message", "move", "navigation", "nothing", "npc", "object",
                "room", "set", "travel"
            ];
            let macroRunning = false;


        function logMessage(message) {
            output.innerHTML = message + "<br>";
            output.scrollTop = output.scrollHeight;
        }

        function saveFile() {
            let elemLimit = 5; // Number of elements per line
            let htmlDoc = document.documentElement.cloneNode(true);
            htmlDoc.querySelector("#output").innerHTML = ""; // Clear output before saving
            let fileName = "worldweaver";

            let fileNameElem = database.filter(item => item.Tags === "!_filename")[0];
            if (fileNameElem && fileNameElem.Output !== "")
            {
                fileName = fileNameElem.Output;
            }

            // Make sure the latest database is stored
            let latestDatabase = JSON.parse(JSON.stringify(database)); // Deep clone to ensure correctness

            // Build compact JSON with newlines every elemLimit items
            let lines = [];
            for (let i = 0; i < latestDatabase.length; i += elemLimit) {
                let chunk = latestDatabase.slice(i, i + elemLimit);
                lines.push(JSON.stringify(chunk).slice(1, -1)); // Strip [ and ]
            }
            let formattedDatabase = `[\n  ${lines.join(",\n  ")}\n]`;

            // Ensure correct replacement of the old database
            let htmlContent = "<!DOCTYPE html>" + htmlDoc.outerHTML;
            htmlContent = htmlContent.replace(/let database = \[([\s\S]*?)\];/, `let database = ${formattedDatabase};`);

            let blob = new Blob([htmlContent], { type: "text/html" });
            let a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${fileName}.html`;
            a.click();
        }

        // Events
        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                let command = input.value.trim();
                if (command) {
                    processInput(command);
                    showOutput();
                }
                input.value = "";
            }
        });

        function showOutput()
        {
            if (gameOutput.MatchMade && gameOutput.Output)
            {
                output.innerHTML += gameOutput.Output + "<br>";
                output.scrollTop = output.scrollHeight;
            }
        }


        function showGameStartScreen()
        {
            let playerElem = database.filter(item => item.ElementKey === "player")[0];

            if (playerElem.Name === "")
            {
                output.innerHTML = "Set player name:";
                return;
            }

            if (!gameStarted)
            {
                let startScreen = "Welcome to WorldWeaver...";
                let startMsg = database.filter(item => item.ParentKey === "game" && item.ElementType === "!_start")[0];
                output.innerHTML = startMsg.Output;
                gameStarted = true;
            }
            else
            {
                output.innerHTML = "";
            }
        }
        

        window.onload = function() {
            gameInterface.style.display = "flex";

            doOnStartRandomFixes();

            showGameStartScreen();

            // Ensure the database is not overwritten if it was injected from a saved file
            if (!Array.isArray(database) || database.length === 0) {
                database = [];
            }

            input.focus();
        };



        function doOnStartRandomFixes()
        {
            let randElems = database.filter(item => item.Output.startsWith("[rand:") || item.Output.startsWith("[roll:"));
            
            for (let rnd of randElems)
            {
                if (rnd.Output.startsWith("[rand:"))
                {
                    setRandValue(rnd);
                }
                else
                {
                    setRollDiceValue(rnd);
                }
            }
        }

        function setRandValue(rndElement) {
            let range = rndElement.Output.replace("[rand:", "").replace(/](?!.*])/ , "").split("|");
            let rndVal = 0;
            if (range.length === 2)
            {
                if (range[0].startsWith("<<"))
                {
                    range[0] = getTargetsByRelCode(rndElement, range[0])[0].Output;
                }
                if (range[1].startsWith("<<"))
                {
                    range[1] = getTargetsByRelCode(rndElement, range[1])[0].Output;
                }

                rndVal = getRandomByRange(range[0], range[1]);
                rndElement.Output = rndVal;
            }
        }

        function getRandomByRange(min, max)
        {
            return Math.floor(Math.random() * Number(max) - Number(min) + 1) + Number(min);
        }

        function setRollDiceValue(rndElement)
        {
            let roll = rndElement.Output.replace("[roll:", "").replace(/](?!.*])/ , "");
            let rndVal = -1;
            let rollVals = [];
            let totalDice = 0;
            let modValue = 0;
            let totalNumOfDice = 0;

            roll = roll.replace(/<<(.+?)>>/g, (_, match) => {
                return getTargetsByRelCode(rndElement, roll)[0].Output;
            });

            if (roll.includes("+") || roll.includes("-"))
            {
                let delimiter = "+";
                if (roll.includes("-"))
                {
                    delimiter = "-";
                }
                modValue = processModifier(rndElement, delimiter, roll);
                let arr = roll.split(delimiter);
                if (arr.Length === 2)
                {
                    roll = arr[0].trim();
                }
            }

            if (roll.includes("(") && roll.includes(")"))
            {
                let arr = roll.split(")");
                if (arr.length == 2)
                {
                    roll = arr[1].trim();
                    arr[0] = arr[0].replace("(", "");
                    try
                    {
                        totalNumOfDice = Number(arr[0]);
                    }
                    catch (Exception)
                    {
                        totalNumOfDice = 0;
                    }
                }
            }

            let diceSpec = roll.split('d');
            try
            {
                if (diceSpec.length == 2)
                {
                    let numOfDice = Number(diceSpec[0].trim());
                    if (diceSpec[1].includes("+") || diceSpec[1].includes("-"))
                    {
                        let sidesArr = diceSpec[1].split("+");
                        if (sidesArr.length !== 2)
                        {
                            sidesArr = diceSpec[1].split("-");
                            diceSpec[1] = sidesArr[0];
                        }
                        else
                        {
                            diceSpec[1] = sidesArr[0];
                        }
                    }
                    let sides = Number(diceSpec[1].trim());
                    let total = 0;
                    let rollNum = numOfDice;
                    if (totalNumOfDice > numOfDice)
                    {
                        rollNum = totalNumOfDice;
                    }

                    for (let rolls = 0; rolls <= rollNum - 1; rolls++)
                    {
                        let rollVal = getRandomByRange(1, sides + 1);
                        rollVals.push(rollVal);
                    }

                    if (totalNumOfDice > numOfDice)
                    {
                        const sorted = rollVals.sort((a, b) => b - a);
                        let taken = sorted.slice(0, numOfDice);
                        total = taken.reduce((acc, curr) => acc + curr, 0);
                    }
                    else {
                        total = rollVals.reduce((acc, curr) => acc + curr, 0);
                    }

                    rndVal = total;

                    total = total + modValue;

                    rndElement.Output = total;
                }
            }
            catch (Exception)
            {
                return rndVal;
            }
        }


        // Fighting
        function showFightInterface() {
            const player = getPlayer();
            const lifeStat = getChildrenByTag(player, "life")[0]?.Output || "0";
            document.getElementById("player-life").textContent = lifeStat;
            document.getElementById("enemy-life").textContent = "10"; // static for now

            gameInterface.style.display = "none";
            document.getElementById("fight-interface").style.display = "flex";
        }

        function exitFight() {
            document.getElementById("fight-interface").style.display = "none";
            gameInterface.style.display = "flex";
        }

        function attackEnemy() {
            let enemyLifeEl = document.getElementById("enemy-life");
            let currentLife = parseInt(enemyLifeEl.textContent);
            let damage = Math.floor(Math.random() * 5) + 1;
            currentLife -= damage;

            if (currentLife <= 0) {
                enemyLifeEl.textContent = "0";
                alert("Enemy defeated!");
                exitFight();
            } else {
                enemyLifeEl.textContent = currentLife.toString();
            }
        }


        // Helper Methods
            function getElement(referenceString, currentElement)
            {
                if (referenceString === "[room]")
                {
                    return getCurrentRoom();
                }
                if (referenceString === "[player]")
                {
                    return getPlayer();
                }
                if (referenceString === "[self]")
                {
                    return getSelf(currentElement);
                }
            }
            function getElementByKey(elementKey)
            {
                let foundElem = database.filter(item => item.ElementKey === elementKey)[0];
                return foundElem;
            }
            function getElementsByType(elementType)
            {
                return database.filter(item => item.ElementType === elementType);
            }
            function getSelf(currentElement)
            {
                let parentElem = getElementByKey(currentElement.ParentKey);

                if (currentElement.ParentKey === null)
                {
                    return null;
                }

                if (selfTypes.includes(parentElem.ElementType))
                {
                    return parentElem;
                }
                else
                {
                    getSelf(parentElem);
                }
            }
            function getParent(currentElement)
            {
                if (currentElement.ParentKey === null)
                {
                    return null;
                }
                let parentElem = database.filter(item => item.ElementKey === currentElement.ParentKey)[0];
                return parentElem;
            }
            function getChildrenByTag(parentElement, tag)
            {
                let children = getChildren(parentElement, true);
                let foundElems = children.filter(item => tagsContain(item.Tags, tag));
                return foundElems;
            }
            function getChildren(parentElement, includeAttributes)
            {
                if (includeAttributes)
                {
                    return database.filter(item => item.ParentKey === parentElement.ElementKey);
                }
                else
                {
                    return database.filter(item => item.ParentKey === parentElement.ElementKey && item.ElementType !== "attribute");
                }
            }
            function getSelf(currentElement)
            {
                let parentElem = getParent(currentElement);
                if (parentElem === null)
                {
                    return currentElement;
                }
                if (selfTypes.includes(parentElem.ElementType))
                {
                    return parentElem;
                }
                else
                {
                    return getSelf(parentElem);
                }
            }
            function getCurrentRoom()
            {
                let playerElem = getElementsByType("player")[0];
                let roomElem = getElementByKey(playerElem.ParentKey);
                return roomElem;
            }
            function getPlayer()
            {
                let playerElem = getElementsByType("player")[0];
                return playerElem;
            }
            function outputMatch(message, doAppend)
            {
                if (message === "")
                {
                    return;
                }

                gameOutput.MatchMade = true;
                if (doAppend)
                {
                    gameOutput.Output += message;
                }
                else
                {
                    gameOutput.Output = message;
                }
            }
            function tagsContain(tags, tagString)
            {
                let taglist = tags.split("|");
                return taglist.includes(tagString);
            }
            function addTag(currentElement, tagString)
            {
                if (currentElement.Tags === undefined)
                {
                    return;
                }
                let taglist = currentElement.Tags.split("|");
                if (!taglist.includes(tagString))
                {
                    taglist.push(tagString);
                }
                currentElement.Tags = taglist.join("|");
            }
            function removeTag(currentElement, tagString)
            {
                let taglist = currentElement.Tags.split("|").filter(item => item !== tagString);
                currentElement.Tags = taglist.join("|");
            }
            function processModifier(currentElement, modifier, roll)
            {
                let arr = roll.split(modifier);
                var modifierVal = 0;

                if (arr.length != 2)
                {
                    return 0;
                }

                try{
                    modifierVal = Number(getTargetsByRelCode(currentElement, arr[1].trim()));
                    if (modifier === "-")
                    {
                        modifierVal = -(modifierVal);
                    }
                }
                catch (Exception)
                {
                    return 0;
                }

                return modifierVal;
            }
        // End Helper Methods



        // Process the Player's input.
        // This will call all the other parsers.
        function processInput(command)
        {
            userInput.Input = command;
            output.innerHTML = "";
            gameOutput.MatchMade = false;
            gameOutput.Output = "";
            gameOutput.ContinueParsing = true;
            gameOutput.EnterMsgDone = false;
            gameOutput.LogicPassed = true;
            output.scrollTop = output.scrollHeight;
            let playerElem = database.filter(item => item.ElementType === "player")[0];

            if (playerElem.Name === "" &&
                userInput.Input != "save" &&
                userInput.Input != "help")
            {
                playerElem.Name = userInput.Input;
                showGameStartScreen();
                parseGame(gameParsers);
                parseRoom(roomParsers, true);
                return;
            }
            if (command === "help")
            {
                outputMatch("I am here to help you!", false);
                gameOutput.MatchMade = true;
                return;
            }
            if (userInput.Input === "save")
            {
                saveFile();
                input.value = "";
                input.focus();
                return;
            }

            if (gameStarted)
            {
                if (userInput.Input === "!fight")
                {
                    showFightInterface();
                }


                parseGame(gameParsers);
                parseGlobal(globalParsers);
                parseRoom(roomParsers, false);
            }
        }


        // Run the parsers
        function parseGame(parsers)
        {
            let gameElem = getElementsByType("game")[0];

            for (let prsr of parsers)
            {
                for (let child of getChildren(gameElem, false))
                {
                    callParser(prsr, gameElem, child);
                }
            }
        }

        function parseAction(currentElement, parsers)
        {
            parseElement(currentElement, parsers);

            if (tagsContain(currentElement.Tags, "type") &&
                currentElement.Logic !== "")
            {
                parseCustomElement(getCurrentRoom(), currentElement.Logic);
            }

            if (tagsContain(currentElement.Tags, "list") &&
                currentElement.Logic !== "")
            {
                parseListAction(currentElement);
            }
        }

        function parseCustomElement(parentElement, customType)
        {
            // Parent Level
            let custElems = database.filter(item => item.ElementType === customType &&
                item.ParentKey === parentElement.ElementKey);

            for (let elem of custElems)
            {
                parseElement(elem, generalParsers);
            }
           
            // Child Level
            let childElems = database.filter(item => canContainCustomElems.includes(item.ElementType) &&
                item.ParentKey === parentElement.ElementKey);

            for (let elem of childElems)
            {
                parseCustomElement(elem, customType);
            }
        }

        function parseInput(currentElement, parsers)
        {
            if (currentElement.Syntax === "")
            {
                return;
            }

            let pattern = new RegExp(currentElement.Syntax, 'i');
            if (pattern.test(userInput.Input))
            {
                parseElement(currentElement, inputParsers);
            }
        }

        function parseListAction(currentElement)
        {
            let caption = currentElement.Output;
            let items = getTargetsByRelCode(currentElement, currentElement.Logic);
            gameOutput.Output = caption + "\n";
            for (let item of items)
            {
                gameOutput.Output += `${item.Name}: ${item.Output}`;
                gameOutput.Output += "\n";
            }
            gameOutput.ContinueParsing = false;
            gameOutput.MatchMade = true;
        }

        function parseLogic(parentElement, childElement)
        {
            gameOutput.LogicPassed = true;
            if (childElement.Logic === "")
            {
                return;
            }
            let logicPassed = [""];
            let logicRows = childElement.Logic.split(/\r?\n/);
            let curOperator = "and";
           
            for (let row of logicRows)
            {
                if (row.startsWith('?'))
                {
                    logicPassed.push(processLogicRow(parentElement, childElement, row.substring(1)));
                }
                else if (row.trim() === "and")
                {
                    curOperator = "and";
                }
                else if (row.trim() === "or")
                {
                    curOperator = "or";
                }

                if (logicPassed.length > 1)
                {
                    if (curOperator === "and" && logicPassed.includes(false))
                    {
                        gameOutput.LogicPassed = false;
                        return;
                    }
                    if (curOperator === "or" && !logicPassed.includes(true))
                    {
                        gameOutput.LogicPassed = false;
                        return;
                    }
                }
            }

            if (logicPassed.includes(false))
            {
                gameOutput.LogicPassed = false;
                return;
            }
        }

            /*

                LOGIC SYNTAX:

                -- operands --
                != 	Not equals to
                >= 	Greater than or equal to
                <= 	Less than or equal to
                !~~ Is not in
                ~~ 	Is in
                >< 	Is outside the bounds
                <> 	Is inside the bounds
                = 	Is equal to
                > 	Is greater than
                < 	Is less than

                -- relative codes --
                [room] 	    The current room
                [player] 	The player element
                [self] 	    This walks up to the first 'self' configured element - (See the SelfTypes.json file)
                [enemy] 	While fighting

                -- special values --
                [children] 	                Returns the child count of the [self] element
                [isday] 	                Returns true if it is 'day time'
                [missiondays] 	            Displays how many days the player has been on the current mission (If any)
                [totaldays] 	            Total in-game days that have passed
                rdm_<random expression> 	Generates a random value to check against (So it doesn't always fire etc) (See Random Syntax)


                -- examples --
                ?(travel01)active = 'true'
                ?(player)((life)) > 0
                ?[self]active = 'true'
                ?[self]((is_discovered)) = 'true'
                ?[self]key ~~ ls(player)((inventory))key
                ?[self]key ~~ ls[room]((discoverable))key
                ?[self]key ~~ ls[room]((discoverable))children
                ?[self]children > 0
                ?(elem_by_key)children < 10
                ?[self]active = 'true'

            */
        function processLogicRow(parentElement, childElement, row)
        {
            let tag = "";
            let target1 = "";
            let field1 = "";
            let specCode1 = "";
            let value1 = "";
            let target2 = "";
            let field2 = "";
            let specCode2 = "";
            let value2 = "";
            let comparisons = splitLogicByOperand(row);
            let operand = getOperand(row);

            if (!Array.isArray(comparisons) || comparisons.length !== 2)
            {
                alert("Malformed logic statement!");
                return false;
            }

            if (operand === "")
            {
                return false;
            }

            value1 = getExplicitValue(comparisons[0]);
            value2 = getExplicitValue(comparisons[1]);

            if (value1 === "")
            {
                target1 = getTargetByTag(childElement, comparisons[0]);
                field1 = getField(comparisons[0]);
                value1 = getFieldValue(target1, field1);
            }
            if (value2 === "")
            {
                target2 = getTargetByTag(childElement, comparisons[1]);
                field2 = getField(comparisons[1]);
                value2 = getFieldValue(target2, field2);
            }

            return valueComparison(operand, value1, value2);
        }
        function splitLogicByOperand(row)
        {
            let splt = "";
            for (let oper of operands)
            {
                splt = row.split(oper);
                if (splt.length === 2)
                {
                    return splt;
                }
            }
        }
        function getOperand(row)
        {
            for (let op of operands)
            {
                if (row.includes(op))
                {
                    return op.trim();
                }
            }

            return "";
        }
        function getExplicitValue(row)
        {
            if (row.startsWith("'") && row.endsWith("'"))
            {
                return row.replaceAll("'", "");
            }
            return "";
        }
        function getFieldValue(curElem, field)
        {
            curElem = curElem;

            switch(field)
            {
                case "ElementType":
                    return curElem.ElementType;
                case "ElementKey":
                    return curElem.ElementKey;
                case "Name":
                    return curElem.Name;
                case "ParentKey":
                    return curElem.ParentKey;
                case "Syntax":
                    return curElem.Syntax;
                case "Logic":
                    return curElem.Logic;
                case "Output":
                    return curElem.Output;
                case "Tags":
                    return curElem.Tags;
                default:
                    return "";
            }
        }
        function setFieldValue(curElem, field, value)
        {
            curElem = curElem[0];

            switch(field)
            {
                case "ElementType":
                    return curElem.ElementType = value;
                case "ElementKey":
                    return curElem.ElementKey = value;
                case "Name":
                    return curElem.Name = value;
                case "ParentKey":
                    return curElem.ParentKey = value;
                case "Syntax":
                    return curElem.Syntax = value;
                case "Logic":
                    return curElem.Logic = value;
                case "Output":
                    return curElem.Output = value;
                case "Tags":
                    return curElem.Tags;
                default:
                    return "";
            }
        }
        function getTargetByTag(childElement, row)
        {
            let tgt = "";
            tgt = getTargetById(row);

            if (tgt === "")
            {
                tgt = getTargetsByRelCode(childElement, row);
            }

            if (row.endsWith("))"))
            {
                let arr = row.split("((");
                if (arr.length === 2)
                {
                    let tag = arr[1].replace("))", "");
                    tgt = getChildrenByTag(tgt, tag);
                }
            }

            return tgt;
        }
        function getTargetById(row)
        {
            if (row.startsWith("("))
            {
                row = row.substring(1);
                let arr = row.split(")");
                return arr[0].trim();
            }

            return "";
        }
        function getTargetsByRelCode(childElement, row)
        {
            let parent = null;
            let childTag = "";
            let returnString = row;
            let relVal = "";

            if (!row.includes("<<"))
            {
                if (Number.isInteger(Number(row)))
                {
                    return row;
                }
            }

            relVal = [...row.matchAll(/<<(.+?)>>/g)].map(match => match[1]);
            if (relVal === "undefined")
            {
                relVal = row;
            }
            if (relVal.length > 0)
            {
                relVal = relVal[0];
            }
            else
            {
                relVal = row;
            }

            if (relVal.startsWith("[self]"))
            {
                parent = getSelf(childElement);
            }
            if (relVal.startsWith("[room]"))
            {
                parent = getCurrentRoom();
            }
            if (relVal.startsWith("[player]"))
            {
                parent = getPlayer();
            }
            // TODO: Add GetEnemy

            let arr = relVal.split("))");
            if (arr.length === 2)
            {
                arr = arr[0].split("((");
                if (arr.length === 2)
                {
                    childTag = arr[1].trim();
                    return getChildrenByTag(parent, childTag);
                }
            }
        }
        function getField(row)
        {
            let arr = "";

            if (row.endsWith("]") || row.endsWith("))") || row.endsWith(")"))
            {
                return "Output";
            }

            arr = row.split("(");
            if (arr.length === 2)
            {
                return arr[1].replaceAll("))", "").trim();
            }

            return "Output";
        }
        function valueComparison(operand, val1, val2)
        {
            switch (operand.trim())
            {
                case "!=":
                    if (val1 !== val2)
                    {
                        return true;
                    }
                    break;
                case ">=":
                    if (val1 >= val2)
                    {
                        return true;
                    }
                    break;
                case "<=":
                    if (val1 <= val2)
                    {
                        return true;
                    }
                    break;

                case "!~~":
                    return !val2.includes(val1);
                case "~~":
                    return val2.includes(val1);
                case "><":
                    return val1 < val2 || val1 > val2;
                case "<>":
                    return val1 > val2 && val1 < val2;
                case "=":
                    return val1 === val2;
                case ">":
                    return val1 > val2;
                case "<":
                    return val1 < val2
            }

            return false;
        }

        function parseEnterMessage()
        {}

        function parseGlobal(parsers)
        {
            let globalElems = getElementsByType("global");

            for (let glob of globalElems)
            {
                for (let prsr of parsers)
                {
                    for (let child of getChildren(glob, false))
                    {
                        callParser(prsr, glob, child, false);
                    }
                }
            }
        }

        function parseMove(currentElement, parsers)
        {
            let targetKey = currentElement.Logic;
            let movingElem = getElement(currentElement.Tags, currentElement);

            if (movingElem != null && targetKey !== "")
            {
                movingElem.ParentKey = targetKey;
                gameOutput.MatchMade = true;
                if (currentElement.Output !== "")
                {
                    gameOutput.Output = currentElement.Output;
                }
                outputMatch(currentElement.Output, false);
                if (movingElem.ElementType === "player")
                {
                    parseRoom(roomParsers, true);
                    gameOutput.ContinueParsing = false;
                }
            }
        }

        function parseObject(parentElement, currentElement, parsers, isEntering)
        {
            for (let prsr of parsers)
            {
                for (let child of getChildren(currentElement, false))
                {
                    callParser(prsr, currentElement, child, isEntering);
                }
            }
        }

        function parseRoom(parsers, isEntering)
        {
            let roomElem = getCurrentRoom();

            for (let prsr of parsers)
            {
                for (let child of getChildren(roomElem, isEntering))
                {
                    callParser(prsr, roomElem, child, isEntering);
                }
            }
        }

        function parseSet(parentElement, currentElement, parsers)
        {
            if (tagsContain(currentElement.Tags, "arm"))
            {
                let armed = "Do the arming logic";
            }

            let field = "";
            let tgt = getTargetById(currentElement.Logic);
            if (typeof tgt.ElementKey === "undefined" || tgt.ElementKey === "")
            {
                tgt = getTargetsByRelCode(currentElement, currentElement.Logic)[0];
            }
            if (tgt.ElementKey !== "")
            {
                field = getField(currentElement.Logic);
            }

            updateElementField(tgt, field, currentElement.Output);
        }

        function updateElementField(currentElement, fieldName, newValue)
        {
            let curValue = getFieldValue(currentElement, fieldName);

            if (newValue.startsWith("+="))
            {
                let inc = Number(newValue.replace("+=", ""));
                curValue = Number(curValue) + inc;
            }
            if (newValue.startsWith("-="))
            {
                let dec = Number(newValue.replace("-=", ""));
                curValue = Number(curValue) - dec;
            }
            if (newValue === "++")
            {
                curValue = Number(curValue) + 1;
            }
            if (newValue === "--")
            {
                curValue = Number(curValue) - 1;
            }

            switch(fieldName)
            {
                case "ElementType":
                    currentElement.ElementType = curValue;
                    break;
                case "ElementKey":
                    currentElement.ElementKey = curValue;
                    break;
                case "Name":
                    currentElement.Name = curValue;
                    break;
                case "ParentKey":
                    currentElement.ParentKey = curValue;
                    break;
                case "Syntax":
                    currentElement.Syntax = curValue;
                    break;
                case "Logic":
                    currentElement.Logic = curValue;
                    break;
                case "Output":
                    currentElement.Output = curValue;
                    break;
                case "Tags":
                    if (newValue.startsWith("+"))
                    {
                        addTag(currentElement, newValue.substring(1));
                    }
                    if (newValue.startsWith("-"))
                    {
                        removeTag(currentElement, newValue.substring(1));
                    }
                    break;
            }
        }

        function parseElement(parentElement, parsers)
        {
            if (!gameOutput.ContinueParsing)
            {
                return;
            }

            for (let prsr of parsers)
            {
                for (let child of getChildren(parentElement, false))
                {
                    callParser(prsr, parentElement, child, false);
                    if (!gameOutput.ContinueParsing)
                    {
                        return;
                    }
                }
            }
        }

        // Parser managing function
        function callParser(curParser, parentElement, childElement, isEntering)
        {
            if (!gameOutput.LogicPassed)
            {
                return;
            }

            switch (curParser)
            {
                case "action":
                    if (childElement.ElementType === "action")
                    {
                        parseAction(childElement, actionParsers);
                    }

                case "enter_message":
                    if (childElement.ElementType === "enter_message" &&
                        parentElement.ElementType !== "game" &&
                        isEntering === true &&
                        !gameOutput.EnterMsgDone
                    )
                    {
                        outputMatch(childElement.Output, true);

                        // Parse non enter_message children
                        let nonEnterChildren = database.filter(item => item.ParentKey === parentElement.ElementKey &&
                            item.ElementType !== "enter_message");

                        for (let nChild of nonEnterChildren)
                        {
                            let childElems = database.filter(item => item.ParentKey === nChild.ElementKey &&
                                item.ElementType === "enter_message");

                            for (let childElem of childElems)
                            {
                                callParser(curParser, nChild, childElem, isEntering);
                            }
                        }

                        gameOutput.EnterMsgDone = true;
                    }
                    break;

                case "input":
                    if (childElement.ElementType === "input")
                    {
                        parseInput(childElement, inputParsers);
                    }
                    break;

                case "logic":
                    if (childElement.ElementType === "logic")
                    {
                        parseLogic(parentElement, childElement);
                    }
                    if (!gameOutput.LogicPassed)
                    {
                        gameOutput.ContinueParsing = false;
                        return;
                    }
                    break;

                case "message":
                    if (childElement.ElementType === "message" && parentElement.ElementType !== "game")
                    {
                        outputMatch(childElement.Output, true);
                    }
                    break;

                case "move":
                    parseMove(childElement, moveParsers);
                    if (!gameOutput.ContinueParsing)
                    {
                        return;
                    }
                    break;

                case "navigation":
                    if (childElement.ElementType === "navigation")
                    {
                        parseElement(childElement, navigationParsers); 
                    }
                    break;

                case "object":
                    if (childElement.ElementType === "object")
                    {
                        parseObject(parentElement, childElement, objectParsers, isEntering);
                    }

                case "set":
                    if (childElement.ElementType === "set")
                    {
                        parseSet(parentElement, childElement, setParsers);
                    }
            }
        }
    </script>
</body></html>
