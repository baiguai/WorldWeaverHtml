<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorldWeaver</title>

    <!--
        Formatting notes:
        This code is formatted for indentation level folding.
        There are sections indented between comments, so that they
        remain collapsed at certain levels, to make code navigation
        and reading easier.
    -->

    <!-- Styles -->
        <style>
            body {
                background-color: black;
                color: white;
                font-family: monospace;
                margin: 0;
                display: flex;
                flex-direction: column;
                height: 100vh;
            }

            #game-interface {
                display: flex;
                flex-direction: column;
                flex: 1;
            }

            #output {
                flex: 1;
                padding: 10px;
                overflow-y: auto;
                white-space: pre-wrap;
                border-bottom: 1px solid white;
            }

            #input-container {
                display: flex;
                padding: 10px;
                background: black;
                border-top: 1px solid white;
            }

            #input {
                flex: 1;
                background: black;
                color: white;
                border: none;
                padding: 10px;
                font-size: 1rem;
                font-family: monospace;
            }

            #input:focus {
                outline: none;
            }

            .link {
                cursor: pointer;
                text-decoration: underline;
            }
        </style>
    <!-- End Styles -->
</head>
<body>
    <div id="game-interface" style="display: none;">
        <div id="output"></div>
        <div id="input-container">
            <input type="text" id="input" autofocus="">
        </div>
    </div>
    
    <script>
        let database = [];

        // Global Vars
            const output = document.getElementById("output");
            const input = document.getElementById("input");
            const gameInterface = document.getElementById("game-interface");
            const elementTypes = [
                "action", "attack", "attribute", "custom", "dev_note", "enter_message", "global", "injection",
                "input", "link", "logic", "message", "move", "navigation", "nothing", "npc", "object",
                "room", "set", "travel"
            ];


        function logMessage(message) {
            output.innerHTML = message + "<br>";
            output.scrollTop = output.scrollHeight;
        }

        function processInput(command) {
            if (command === "help")
            {
                logMessage("I am here to help you!");
                return;
            }
            if (command === "save")
            {
                saveFile();
                input.value = "";
                input.focus();
                return;
            }
        }


        function saveFile() {
            let elemLimit = 5; // Number of elements per line
            let htmlDoc = document.documentElement.cloneNode(true);
            htmlDoc.querySelector("#output").innerHTML = ""; // Clear output before saving

            // Make sure the latest database is stored
            let latestDatabase = JSON.parse(JSON.stringify(database)); // Deep clone to ensure correctness

            // Build compact JSON with newlines every elemLimit items
            let lines = [];
            for (let i = 0; i < latestDatabase.length; i += elemLimit) {
                let chunk = latestDatabase.slice(i, i + elemLimit);
                lines.push(JSON.stringify(chunk).slice(1, -1)); // Strip [ and ]
            }
            let formattedDatabase = `[\n  ${lines.join(",\n  ")}\n]`;

            // Ensure correct replacement of the old database
            let htmlContent = "<!DOCTYPE html>" + htmlDoc.outerHTML;
            htmlContent = htmlContent.replace(/let database = \[([\s\S]*?)\];/, `let database = ${formattedDatabase};`);

            let blob = new Blob([htmlContent], { type: "text/html" });
            let a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "worldweaver.html";
            a.click();
        }

        // Events
        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                let command = input.value.trim();
                if (command) {
                    processInput(command);
                }
                input.value = "";
            }
        });
        

        window.onload = function() {
            gameInterface.style.display = "flex";
            output.innerHTML = "Game Output Will Be Here";

            // Ensure the database is not overwritten if it was injected from a saved file
            if (!Array.isArray(database) || database.length === 0) {
                database = [];
            }

            input.focus();
        };
    </script>
</body></html>
