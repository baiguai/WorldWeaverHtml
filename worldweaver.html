<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standalone Console</title>
    <style>
        body 
            background-color: black;
            color: white;
            font-family: monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #game-interface {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        #output {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-bottom: 1px solid white;
        }

        #input-container {
            display: flex;
            padding: 10px;
            background: black;
            border-top: 1px solid white;
        }

        #input {
            flex: 1;
            background: black;
            color: white;
            border: none;
            padding: 10px;
            font-size: 1rem;
            font-family: monospace;
        }

        #input:focus {
            outline: none;
        }

        /* Initially hide the admin interface */
        #admin-interface {
            display: none; /* Hide admin interface by default */
            flex: 1;
            height: 100vh;
            display: flex;
        }

        #treeview {
            width: 200px;
            border-right: 1px solid white;
            overflow-y: auto;
            padding: 10px;
            resize: horizontal;
            min-width: 100px;
            max-width: 50%;
        }

        #treeview ul {
            list-style: none;
            padding-left: 10px;
        }

        #treeview li {
            cursor: pointer;
        }

        #details {
            flex: 1;
            padding: 10px;
        }

        #admin-input-container {
            display: none;
            padding: 10px;
            background: black;
            border-top: 1px solid white;
        }

        #admin-input {
            width: 100%;
            background: black;
            color: white;
            border: none;
            padding: 10px;
            font-size: 1rem;
            font-family: monospace;
        }

        #admin-input:focus {
            outline: none;
        }

        #editor-container {
            display: none;
            flex: 1;
            padding: 10px;
            flex-direction: column;
        }

        #editor {
            flex: 1;
            background: black;
            color: white;
            border: 1px solid white;
            padding: 10px;
            font-size: 1rem;
            font-family: monospace;
            white-space: pre;
            overflow-y: auto;
        }

        #editor-close {
            align-self: flex-end;
            cursor: pointer;
            padding: 5px;
            color: red;
        }
    </style>
</head>
<body>
    <div id="game-interface">
        <div id="output">Game Output Will Be Here</div>
        <div id="input-container">
            <input type="text" id="input" autofocus>
        </div>
    </div>
    
    <div id="admin-interface">
        <div id="treeview"></div>
        <div id="details">Select an item to see details.</div>
        <div id="editor-container">
            <div id="editor-close">X</div>
            <textarea id="editor"></textarea>
        </div>
    </div>
    <div id="admin-input-container">
        <input type="text" id="admin-input">
    </div>
    
    <script>
        let database = [];
        let currentParent = null;
        const output = document.getElementById("output");
        const input = document.getElementById("input");
        const adminInput = document.getElementById("admin-input");
        const gameInterface = document.getElementById("game-interface");
        const adminInterface = document.getElementById("admin-interface");
        const adminInputContainer = document.getElementById("admin-input-container");
        const treeview = document.getElementById("treeview");
        const details = document.getElementById("details");
        const editorText = document.getElementById("editor");
        const editorClose = document.getElementById("editor-close");
        const elementTypes = [
            "action", "attack", "attribute", "custom", "dev_note", "enter_message", "game", "global", "injection",
            "input", "link", "logic", "message", "move", "navigation", "nothing", "npc", "object",
            "player", "room", "set", "travel"
        ];


        function createElement(elementKey, elementType, name, doLogging)
        {
            if (elementKey == "")
            {
                elementKey = getGuid();
            }

            let entry = {
                ElementType: elementType,
                ElementKey: elementKey,
                Name: name,
                ParentKey: currentParent,
                Syntax: "",
                Logic: "",
                Output: "",
                Tags: "",
                Repeat: "",
                RepeatIndex: "",
                Template: "",
                Active: "",
                Sort: ""
            };

            database.push(entry);
            buildTreeView();

            if (doLogging == true)
            {
                logAdminMessage("Added: " + entry.Name);
            }
        }

        function updateElementType(item, newType) {
            item.ElementType = newType;
            showDetails(item);
        }


        function logMessage(message) {
            output.innerHTML = message + "<br>";
            output.scrollTop = output.scrollHeight;
        }
        function logAdminMessage(message) {
            details.innerHTML = message + "<br>";
            details.scrollTop = output.scrollHeight;
        }

        function getGuid() {
            return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
        }

        function processInput(command) {
            if (command === "!_admin") {
                enterAdminMode();
                return;
            }
        }

        function processAdminInput(command) {
            if (command === "exit") {
                exitAdminMode();
            }

            if (command.startsWith("add ")) {
                createElement("", "", command.substring(4), true);
            } else if (command === "save") {
                saveFile();
            } else {
                logMessage("Unknown command: " + command);
            }
        }

        function saveFile() {
            let htmlDoc = document.documentElement.cloneNode(true);
            htmlDoc.querySelector("#output").innerHTML = ""; // Clear output before saving
            let htmlContent = "<!DOCTYPE html>" + htmlDoc.outerHTML;
            htmlContent = htmlContent.replace(/let database = \[.*?\];/, `let database = ${JSON.stringify(database)};`);
            let blob = new Blob([htmlContent], { type: "text/html" });
            let a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "console.html";
            a.click();
        }

        function enterAdminMode() {
            gameInterface.style.display = "none";
            adminInterface.style.display = "flex";  // Show admin interface
            adminInputContainer.style.display = "flex";  // Show admin input field
            input.value = "";
            buildTreeView();
            adminInput.focus();  // Focus the admin input field
        }

        function exitAdminMode() {
            gameInterface.style.display = "flex";
            adminInterface.style.display = "none"; // Hide admin interface
            adminInputContainer.style.display = "none"; // Hide admin input field
            adminInput.value = "";
            input.focus();  // Focus the game input field
        }

        function buildTreeView() {
            treeview.innerHTML = "";
            let rootItems = database.filter(item => item.ParentKey === null);
            let ul = document.createElement("ul");
            rootItems.forEach(item => ul.appendChild(createTreeNode(item)));
            treeview.appendChild(ul);
        }

        function createTreeNode(item) {
            let li = document.createElement("li");
            let span = document.createElement("span");
            span.textContent = item.Name;
            span.style.cursor = "pointer";
            span.addEventListener("click", (event) => {
                event.stopPropagation(); // Prevent event bubbling
                showDetails(item);
                let childUl = li.querySelector("ul");
                if (childUl) {
                    childUl.style.display = childUl.style.display === "none" ? "block" : "none";
                }
            });

            li.appendChild(span);

            let children = database.filter(child => child.ParentKey === item.ElementKey);
            if (children.length > 0) {
                let ul = document.createElement("ul");
                ul.style.display = "none"; // Initially collapse children
                children.forEach(child => ul.appendChild(createTreeNode(child)));
                li.appendChild(ul);
            }

            return li;
        }

        function escapeSpecialChars(str) {
            // Escape special characters in regex to avoid issues
            return str.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&');
        }

        function showEditor(item) {
            document.getElementById("details").style.display = "none";
            document.getElementById("editor-container").style.display = "flex";
            const editor = document.getElementById("editor");
            editor.value = item.Output;
            editor.focus();
            editor.addEventListener("input", function() {
                item.Output = editor.value;
            });
        }

        function closeEditor() {
            document.getElementById("details").style.display = "block";
            document.getElementById("editor-container").style.display = "none";
            adminInput.focus();  // Focus the admin input field
        }

        function showDetails(item) {
            currentParent = item.ElementKey;
            
            let dropdown = `<select id='elementTypeSelect'>`;
            dropdown += elementTypes.map(type => `<option value='${type}' ${item.ElementType === type ? "selected" : ""}>${type}</option>`).join('');
            dropdown += `</select>`;

            let parentDropdown = `<select id="parentSelect">`;
            parentDropdown += `<option value="null" ${item.ParentKey === null ? "selected" : ""}>No Parent</option>`;
            database.forEach(otherItem => {
                if (otherItem.ElementKey !== item.ElementKey) {
                    parentDropdown += `<option value="${otherItem.ElementKey}" ${item.ParentKey === otherItem.ElementKey ? "selected" : ""}>${otherItem.Name}</option>`;
                }
            });
            parentDropdown += `</select>`;

            details.innerHTML = `
                <p><strong>Element Type:</strong> ${dropdown}</p>
                <p><strong>Element Key:</strong> ${item.ElementKey}</p>
                <p><strong>Name:</strong> ${item.Name}</p>
                <p><strong>Parent Key:</strong> ${parentDropdown}</p>
                <p><strong>Syntax:</strong> <span id="syntax-caption">${item.Syntax || "Click to Edit"}</span></p>
                <p><strong>Logic:</strong> ${item.Logic}</p>
                <p><strong>Output:</strong> <span id="output-field" style="cursor:pointer; text-decoration:underline;">${item.Output || "Click to View/Edit"}</span></p>
                <p><strong>Tags:</strong> ${item.Tags}</p>
                <p><strong>Repeat:</strong> ${item.Repeat}</p>
                <p><strong>Repeat Index:</strong> ${item.RepeatIndex}</p>
                <p><strong>Template:</strong> ${item.Template}</p>
                <p><strong>Active:</strong> ${item.Active}</p>
                <p><strong>Sort:</strong> ${item.Sort}</p>
            `;

            // Add event listener for syntax caption click
            document.getElementById("syntax-caption").addEventListener("click", function() {
                let inputField = document.createElement("input");
                inputField.type = "text";
                inputField.value = item.Syntax || "";
                inputField.style = "width: 400px";
                inputField.addEventListener("keypress", function(event) {
                    if (event.key === "Enter") {
                        let inputText = inputField.value.trim();
                        if (inputText) {
                            try {
                                // Split input by pipe, trim, and escape special characters
                                let escapedInput = inputText
                                    .split("|")           // Split on the pipe symbol
                                    .map(part => part.trim())  // Trim any leading/trailing whitespace
                                    .map(part => escapeSpecialChars(part))  // Escape regex special characters
                                    .join("|");           // Join with | to match any of the terms

                                // Construct the regex string
                                let regexString = `\\b(${escapedInput})\\b`; // Match whole words

                                // Store the regex string with case-insensitive flag
                                item.Syntax = `/(?i)${regexString}/`;

                                // Log for debugging
                                console.log("Escaped Regex Input:", escapedInput);
                                console.log("Regex String:", item.Syntax);

                                showDetails(item); // Update details view
                            } catch (error) {
                                alert("Error generating regex: " + error.message);
                            }
                        }
                    }
                });

                // Replace the caption with the input field
                this.replaceWith(inputField);
                inputField.focus();  // Focus on the input field
            });

            document.getElementById("elementTypeSelect").addEventListener("change", function() {
                if (item.ElementType != "game" && item.ElementType != "player") {
                    updateElementType(item, this.value);
                }
            });

            // Update parent key when selection changes
            document.getElementById("parentSelect").addEventListener("change", function() {
                let newParentKey = this.value === "null" ? null : this.value;
                if (item.ParentKey !== newParentKey) {
                    item.ParentKey = newParentKey;
                    buildTreeView(); // Rebuild the tree view after the parent key change
                }
            });

            document.getElementById("output-field").addEventListener("click", function() {
                showEditor(item);
            });

            adminInput.focus();  // Focus the admin input field
        }


        // Events
        editorClose.addEventListener("click", closeEditor);
        editorText.addEventListener("keydown", function(event) {
            if (event.key === "Escape") {
                closeEditor();
            }
        });

        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                let command = input.value.trim();
                if (command) {
                    processInput(command);
                }
                input.value = "";
            }
        });
        
        adminInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                let command = adminInput.value.trim();
                if (command) {
                    processAdminInput(command);
                }
                adminInput.value = "";
            }
        });


        // Ensure admin interface is hidden on load
        window.onload = function() {
            gameInterface.style.display = "flex";
            output.innerHTML = "Game Output Will Be Here";
            adminInterface.style.display = "none";
            adminInputContainer.style.display = "none";

            // Ensure the database is not overwritten if it was injected from a saved file
            if (!Array.isArray(database) || database.length === 0) {
                database = [];
                createElement("game", "game", "Game", false);
                createElement("player", "player", "Player", false);
            }

            buildTreeView();
            input.focus();  // Focus the admin input field
        };
    </script>
</body>
</html>
