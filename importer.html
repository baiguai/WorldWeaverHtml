<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NRMN Importer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #00ff00;
            font-family: monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #databaseText {
            flex: 1;
            background-color: #000;
            color: #00ff00;
            border: none;
            resize: none;
            padding: 10px;
            font-size: 14px;
        }

        #bottom-bar {
            background-color: #000;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        #directoryPath {
            background-color: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px;
            flex: 1;
            font-family: monospace;
        }

        button {
            background-color: #111;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            cursor: pointer;
        }

        button:hover {
            background-color: #222;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>

    <textarea id="databaseText" readonly></textarea>

    <div id="bottom-bar">
        <button onclick="triggerBrowse()">Browse</button>
        <input type="file" id="directoryPicker" webkitdirectory>
        <button onclick="copyDatabase()">Copy</button>
    </div>

    <script>
        let rootDirectoryPath = null;
        let output = document.getElementById('databaseText');
        const directoryPathInput = document.getElementById('directoryPath');
        const directoryPicker = document.getElementById('directoryPicker');
        let loadedDirs = [];
        let loadedFiles = [];
        let database = [];


        async function listAllFilesAndDirs(dirHandle, parentDir) {
            for await (let [name, handle] of dirHandle) {
                const { kind } = handle;
                if (kind === 'directory') {
                    loadedDirs.push({ name, handle, parent: `${parentDir}`, path: `${parentDir}${name}/`, content: "" });
                    const nestedFiles = await listAllFilesAndDirs(handle, `${parentDir}${name}/`);
                    loadedFiles.push(...nestedFiles);
                } else {
                    // Read file content
                    try {
                        const file = await handle.getFile();
                        const content = await file.text();
                        loadedFiles.push({ name, handle, parent: `${parentDir}`, path: `${parentDir}${name}`, content });
                    } catch (err) {
                        console.error(`Error reading file ${name}:`, err);
                        loadedFiles.push({ name, handle, content: "" });
                    }
                }
            }
            return "";
        }

        async function triggerBrowse() {
            try {
                    const directoryHandle = await window.showDirectoryPicker()
                    rootDirectoryPath = directoryHandle;
                    // const files = await listAllFilesAndDirs(directoryHandle, "~/");
                    await listAllFilesAndDirs(directoryHandle, "~/");
                    output.innerHTML = 'Directories:\r\n';
                    for (dir of loadedDirs)
                    {
                        output.innerHTML += `${dir.path}\r\n`;
                    }
                    output.innerHTML += '\r\n';
                    output.innerHTML += 'Files:\r\n';
                    for (file of loadedFiles)
                    {
                        output.innerHTML += `${file.path}\r\n`;
                    }
            }catch(e) {
                    console.log(e);
            }
        }

        function copyDatabase() {
            const textArea = document.getElementById('databaseText');
            textArea.select();
            document.execCommand('copy');
            alert('Database text copied to clipboard!');
        }
    </script>

</body>
</html>
